---
title: "Navigating towards 30% protected nature in Denmark"
author: "Derek Corcoran"
date: "`r format(Sys.time(), '%d/%m, %Y')`"
output:
  ioslides_presentation:
    widescreen: true
    incremental: true
    logo: SustainScapes_Colour.png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE)
```

```{r LoadPackages}
library(terra)
library(leaflet)
library(leafsync)
library(tidyterra)
library(ggplot2)
library(geodata)
library(htmltools)
library(dplyr)
library(patchwork)
```

## How to plan for futute landscapes {.smaller}

$\begin{align*} \text{Maximize} & = \text{Biodiversity} + \text{Resilience} + \text{Carbon} - \text{Yield}\end{align*}$

> -   Biodiversity
>     -   Community composition and rarity
>     -   Phylogenetic Diversity
>     -   Functional diversity*
> -   Resilience
>     -   Contiguity (Area)
>     -   Network stability (Trophic and/or mutualistic)*
>     -   Ecosystem Functioning*
> -   Ecosystem services
>     -   Above and bellowground carbon potential*
> -   Yield
>     -   Current and potential **food** production*

## Definitions

* $\text{EN}$ represents Existingnature.

## Biodiversity

<div style="display:flex; flex-direction:column;">

<div style="flex:1; padding-bottom:20px;">
  
$$\color{Red}{\text{Biodiversity} = \sum_{l}^L \sum_{c}^C \text{LD}_{l,c} \times \frac{\text{S}_{l,c} + \text{PD}_{l,c} + \text{R}_{l,c}}{3} \times \text{CC}_{c}}$$

</div>

<div style="display:flex; flex-direction:row;">
  
<div style="flex:1; padding-right:20px;">
  
```{r Biodiversityplot, fig.width=6, fig.height=4}
Biodiversity <- terra::rast("Biodiversity.tif")

Richness <- ggplot() + geom_spatraster(data = Biodiversity[[3]]) + theme_bw() + scale_fill_wiki_c(direction = -1, name = "S") + theme(legend.position = "bottom")+ ggtitle("Open Wet Rich")

PD <- ggplot() + geom_spatraster(data = Biodiversity[[1]]) + theme_bw() + scale_fill_wiki_c(direction = -1, name = "PD") + theme(legend.position = "bottom") + ggtitle("Open Wet Rich")

Rarity <- ggplot() + geom_spatraster(data = Biodiversity[[1]]) + theme_bw() + scale_fill_wiki_c(direction = -1, name = "R") + theme(legend.position = "bottom") + ggtitle("Open Wet Rich")

Richness + PD + Rarity
```
</div>
<div style="flex:1; font-size: 80%;">

* $\text{L}$ represents the set of Landuses.
* $\text{C}$ represents the set of Cells.
* $\text{LD}_{l,c}$ represents if a cell $c$ is selecte to change to landuse $l$.
* $\text{S}$ represents Richness.
* $\text{PD}$ represents PhyloDiversity.
* $\text{R}$ represents Rarity.
* $\text{CC}$ represents CanChange.

</div>
</div>
</div>

## Contiguity to new nature

<div style="display:flex; flex-direction:column;">

<div style="flex:1; padding-bottom:20px;">

$$
\color{Blue}{\text{Contiguity to new} = \text{SCB} \times \sum_{(i,j)}^E \sum_{l}^L \sum_{c}^C \text{LD}_{l,i} \times \text{LD}_{l,j} \times \text{CC}_{i} \times \text{CC}_{j} }
$$

</div>

<div style="display:flex; flex-direction:row;">
  
<div style="flex:1; padding-right:20px;">

```{r}
AarhusSols <- terra::rast("AarhusSols.tif")

DF <- levels(AarhusSols[[1]])
AarhusSols <- as.numeric(AarhusSols[[c(1,3)]])
r <- rast()
ext(r) <- c(558630.889592757, 571691.729617464, 6226102.68696538, 6237719.7345256)

SmallAarhus <- AarhusSols |> terra::crop(r)

for(i in 1:nlyr(SmallAarhus)){
  levels(SmallAarhus[[i]]) <- DF
}

names(SmallAarhus) <-names(AarhusSols)

ggplot() + geom_spatraster(data = SmallAarhus) + facet_wrap(~lyr) + scale_fill_manual(values =  c("#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", 
                                                                                                  "#bf812d", "#8c510a"), na.value = "#00000000") 
```

</div>
<div style="flex:1; font-size: 80%;">

* $\text{SCB}$ represents SpatialContiguityBonus.
* $E_{i,j}$ Is an edge joining Cells i, and j

</div>
</div>
</div>

## Contiguity to existing nature

$$
\color{Green}{\text{Contiguity to existing} = \text{SCB} \times \sum_{(i,j)}^E \sum_{l}^L \sum_{c}^C \text{LD}_{l,i} \times \text{EN}_{l,j} \times \text{CC}_{i}}
$$

```{r Current}
beforeafter <- terra::rast("Before_After.tif")[[1]]

Communes <- geodata::gadm("Denmark", level = 2, path = getwd())
Communes <- Communes[Communes$NAME_2 %in% c("Århus", "Skanderborg", "Syddjurs"),]

Communes <- Communes |> terra::project(terra::crs(beforeafter))

ggplot() + geom_spatvector(data = Communes) + geom_spatraster(data = beforeafter) + scale_fill_manual(name = "Landuse",values =  c("white","#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", 
"#bf812d", "#8c510a"), na.value = "#00000000") + theme_dark() + ggtitle("Current nature")
```


## Optimization function

$$
\text{maximize CI} = \color{Red}{\text{Biodiversity}} + \color{Purple}{\text{SCB}} \times \left( \color{Blue}{\text{Cont}_n} +  \color{Green}{\text{Cont}_{ex}} \right) 
$$

* Spatial Contiguity Bonus (SCB) is a dial

<center>
```{r}
knitr::include_graphics("Eleven.jpeg")
```
</center>

## Example Landuse (Global contribution)




```{r}
library(readr)
Optimal <- read_table("OptimalAarhus.txt", 
    col_names = FALSE) |> 
  mutate_if(is.numeric, ~round(.x, digits = 2))

colnames(Optimal) <- c("Biodiversity", "Contiguity","ContiguityBonus")

OptimalLong <- Optimal |>
  tidyr::pivot_longer(Biodiversity:Contiguity, names_to = "Part", values_to = "Contribution")


G <- ggplot(OptimalLong, aes(x = ContiguityBonus, y = Contribution, group = Part)) + geom_path(aes(color = Part)) + theme_bw()
G <- plotly::ggplotly(G)

contiguity_index <- which(sapply(G$x$data, function(trace) trace$name == "Contiguity"))

G$x$data[[contiguity_index]]$visible <- "legendonly"

biodiversity_index <- which(sapply(G$x$data, function(trace) trace$name == "Biodiversity"))

# Get the range of the "Biodiversity" trace
x_range <- range(G$x$data[[biodiversity_index]]$x)
y_range <- range(G$x$data[[biodiversity_index]]$y)

# Set initial axis range based on "Biodiversity" trace
G$x$layout$xaxis$range <- x_range
G$x$layout$yaxis$range <- y_range
```

$$
\text{maximize CI} = \color{Red}{\text{Biodiversity}} + \color{Purple}{\text{SCB}} \times \left( \color{Blue}{\text{Cont}_n} \right) 
$$

```{r}
AarhusSols <- terra::rast("AarhusSols.tif")
AarhusSols <- as.numeric(AarhusSols[[1:4]])
Pal <- colorBin(palette = c("#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", "#bf812d", "#8c510a"), domain = values((AarhusSols)[[1]]), na.color = "transparent")
factor_labels <- c("ForestDryPoor", "ForestDryRich", "ForestWetPoor", "ForestWetRich", 
                   "OpenDryPoor", "OpenDryRich", "OpenWetPoor", "OpenWetRich") 

L <- leaflet(height = 300) |> addProviderTiles("CartoDB.DarkMatter") |> addRasterImage(AarhusSols[[1]], color = Pal, group = "0") |>
  addRasterImage(AarhusSols[[2]], color = Pal, group = "0.05") |> addRasterImage(AarhusSols[[3]], color = Pal, group = "0.1") |>  addRasterImage(AarhusSols[[4]], color = Pal, group = "0.15") |>
  addLegend(
  "bottomright",
  title = "Land Use",
  colors = c("#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", "#bf812d", "#8c510a"),
  labels = factor_labels,
  opacity = 1
) |> addLayersControl(
    baseGroups = c("0", "0.05", "0.1", "0.15"),
    options = layersControlOptions(collapsed = T)
  )
```


```{r}
htmltools::div(
  style = "display: flex; justify-content: space-between;",
  G,
  L
)
```

## Local contribution

```{r LocalContribution}
# Load the raster data for the first map
AarhusSols <- terra::rast("AarhusSols.tif")
AarhusSols <- as.numeric(AarhusSols[[1:4]])
Pal1 <- colorBin(palette = c("#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", "#bf812d", "#8c510a"), domain = values((AarhusSols)[[1]]), na.color = "transparent")
factor_labels1 <- c("ForestDryPoor", "ForestDryRich", "ForestWetPoor", "ForestWetRich", 
                    "OpenDryPoor", "OpenDryRich", "OpenWetPoor", "OpenWetRich") 

# Create the first leaflet map
L1 <- leaflet(height = 300) |> addProviderTiles("CartoDB.DarkMatter") |> 
  addRasterImage(AarhusSols[[1]], color = Pal1, group = "0") |>
  addRasterImage(AarhusSols[[2]], color = Pal1, group = "0.05") |>
  addRasterImage(AarhusSols[[3]], color = Pal1, group = "0.1") |>
  addRasterImage(AarhusSols[[4]], color = Pal1, group = "0.15") |>
  addLegend(
    "bottomright",
    title = "Land Use",
    colors = c("#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", "#bf812d", "#8c510a"),
    labels = factor_labels1,
    opacity = 1
  ) |>
  addLayersControl(
    baseGroups = c("0", "0.05", "0.1", "0.15"),
    options = layersControlOptions(collapsed = T)
  )

# Load the raster data for the second map
AarhusLocals <- terra::rast("AarhusLocals.tif")
AarhusLocals <- as.numeric(AarhusLocals[[1:4]])
Pal2 <- colorBin(palette = c('#e41a1c','#377eb8','#4daf4a'), domain = c(1,2,3), na.color = "transparent")
factor_labels2 <- c("Biodiversity", "Contiguity", "Equal") 

# Create the second leaflet map
L2 <- leaflet(height = 300) |> addProviderTiles("CartoDB.DarkMatter") |> 
  addRasterImage(AarhusLocals[[1]], color = Pal2, group = "0") |>
  addRasterImage(AarhusLocals[[2]], color = Pal2, group = "0.05") |>
  addRasterImage(AarhusLocals[[3]], color = Pal2, group = "0.1") |>
  addRasterImage(AarhusLocals[[4]], color = Pal2, group = "0.15") |>
  addLegend(
    "bottomright",
    title = "Land Use",
    colors = c('#e41a1c','#377eb8','#4daf4a'),
    labels = factor_labels2,
    opacity = 1
  ) |>
  addLayersControl(
    baseGroups = c("0", "0.05", "0.1", "0.15"),
    options = layersControlOptions(collapsed = T)
  )

# Combine the leaflet maps
leafsync::sync(L1, L2, ncol = 2, sync = "all")
```

# Latest problem iteration

## Solving for three communes

```{r Comunes}
beforeafter <- terra::rast("Before_After.tif")

Communes <- geodata::gadm("Denmark", level = 2, path = getwd())
Communes <- Communes[Communes$NAME_2 %in% c("Århus", "Skanderborg", "Syddjurs"),]

Communes <- Communes |> terra::project(terra::crs(beforeafter))

ggplot() + geom_spatvector(data = Communes, aes(fill = NAME_2))  + scale_fill_discrete(name= "Commune")  + theme_dark()
```

## Current landuse

```{r Now}

ggplot() + geom_spatvector(data = Communes) + geom_spatraster(data = beforeafter[[1]]) + scale_fill_manual(name = "Current", values =  c("white","#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", 
"#bf812d", "#8c510a"), na.value = "#00000000") + theme_dark()

```

## Problem

* Transform 5,691 cells from agriculture to nature
* At least 2,405 have to turn to Forest (FWR, FWP, FDR or FDP)
* At least 962 have to become Wet Nature (FWR, FWP, OWR, OWP)
* There has to be at least 284 cells of each Nature type

## Before after

```{r before_after}

ggplot() + geom_spatvector(data = Communes) + geom_spatraster(data = beforeafter) + scale_fill_manual(values =  c("white","#01665e", "#35978f", "#80cdc1", "#c7eae5", "#f6e8c3", "#dfc27d", 
"#bf812d", "#8c510a"), na.value = "#00000000") + facet_wrap(~lyr) + theme_dark()

```

## It can be done for the whole country

```{r Country}
knitr::include_url("https://derek-corcoran-barrios.github.io/COG/TestCOG2.html")
```


# Future directions

## Carbon

$$\text{Carbon} = \sum_{l}^L \sum_{c}^C\text{AGC}_{c,l} + \text{BGC}_{c,l}$$

## Yield

$$\text{Yield} = \sum_{c}^C\text{Yield}_{c}$$