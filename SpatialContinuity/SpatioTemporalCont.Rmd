---
title: "Use of the SpatioTemporalCont for calculating simple spatial and temporal continuity"
author: "Derek Corcoran"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE)
library(SpatioTemporalCont)
library(terra)
library(tidyterra)
library(ggplot2)
library(purrr)
library(supercells)
library(motif)
library(patchwork)
library(kableExtra)
```

## Package SpatioTemporalCont

::: {style="float: left; width: 30%;"}
* Very simple package with a couple of functions
* `calculate_prop` for spatial continuity
* `calculate_tempcont` for temporal continuity
* First example using basemap
:::

::: {style="float: right; width: 70%;"}
```{r Basemap2, out.width="70%", echo = F, cache = T}
data("Landuse_DK")
Landuse <- unwrap(Landuse_DK)
ggplot() + 
  geom_spatraster(data = Landuse) +
  scale_fill_wiki_d(na.translate = F, name = "Landuse")
```
:::

# Spatial continuity

## calculate_prop

* It has 3 arguments:
    - Rast: the spatRaster to use
    - Radius: The radius to consider
    - Vars: The variables to calculate
* It generates a stack of rasters

```{r test, eval = F}
Landuse <- terra::unwrap(Landuse_DK)

proportions <- calculate_prop(Rast = Landuse,
                              Radius = 200,
                              Vars = c("dry nature", "Forest"))
```


## calculate_prop Result

```{r Proportions, echo = F, cache=TRUE}
Landuse <- terra::unwrap(Landuse_DK)

proportions <- calculate_prop(Rast = Landuse,
                              Radius = 200,
                              Vars = c("dry nature", "Forest"))

ggplot() + 
  geom_spatraster(data = proportions) +
  facet_wrap(~lyr) +
  scale_fill_wiki_c(name = "Landuse prop")
```

## Comparison for forest several radius

```{r loopPlot, cache = T, out.width= "100%", echo=FALSE}
Landuse <- terra::unwrap(Landuse_DK)
Stack <- list()

Radii <- round(seq(200, 3000, length.out = 6), -2)
for(i in 1:length(Radii)){
  Stack[[i]] <- calculate_prop(Rast = Landuse,
                              Radius = Radii[i],
                              Vars = c("Forest"))
}
Stack <- Stack |> 
  purrr::reduce(c) 

names(Stack) <- Radii

ggplot() + 
  geom_spatraster(data = Stack) +
  facet_wrap(~lyr) +
  scale_fill_wiki_c(name = "Landuse prop")
```

## Comparison with Supercells

* Lets compare at 2400 radius

```{r Compare, eval=FALSE}
Forest <- calculate_prop(Rast = Landuse,
                              Radius = 2400,
                              Vars = c("Forest"))


Forest_Motif <- lsp_signature(Landuse, type = "composition", window = 24, normalization = "pdf", ordered = FALSE)
Forest_Motif = lsp_add_terra(Forest_Motif)
Forest_Motif <- Forest_Motif[[8]]
```

## Results {.smaller} 

* Lost resolution in Supercells (Resolution 2400 vs 100 mts)
* SpatioTemporalCont has circular buffer, Supercells has 2400 meter window

```{r PlotComp, echo=FALSE, cache=TRUE, out.width="60%"}
Landuse <- terra::unwrap(Landuse_DK)
Forest <- calculate_prop(Rast = Landuse,
                              Radius = 2400,
                              Vars = c("Forest"))


Forest_Motif <- lsp_signature(Landuse, type = "composition", window = 24, normalization = "pdf", ordered = FALSE)
Forest_Motif = lsp_add_terra(Forest_Motif)
Forest_Motif <- Forest_Motif[[8]]
data("Polygons")
v <- vect(Polygons, "polygons", crs = terra::crs(Landuse))
G1 <- ggplot() + geom_spatraster(data = crop(Forest, v)) + scale_fill_wiki_c(limits = c(0,1)) + ggtitle("SpatioTemporalCont")

G2 <- ggplot() + geom_spatraster(data = crop(Forest_Motif, v)) + scale_fill_wiki_c(limits = c(0,1)) + ggtitle("Supercells")
G1 + G2  +
    plot_layout(guides = 'collect')
```

## For polygons only

* summarise_polygons, three types "Inside", "Both" or "Outside"

```{r geometries, echo=FALSE, cache=TRUE}
data(Polygons)
data("Landuse_DK")
Landuse <- terra::unwrap(Landuse_DK)

v <- vect(Polygons, "polygons", crs = terra::crs(Landuse))
v_buff <- terra::buffer(v, 2500)

v_erased <- purrr::map(1:nrow(v_buff), ~erase(v_buff[.x, ], v[.x, ])) |> 
    purrr::reduce(rbind)

v$type <- "Inside"
v_buff$type <- "Both"
v_erased$type <- "Outside"

SmallLand <- Landuse |> terra::crop(v_buff)

Pols <- list(v, v_buff, v_erased) |> 
  purrr::reduce(rbind)
ggplot() + geom_spatraster(data = SmallLand) + geom_spatvector(data = Pols, alpha = 0.8) + facet_wrap(~type) +
  scale_fill_wiki_d(na.translate = F, name = "Landuse")
```

## Inside

```{r Inside}
data(Polygons)
data("Landuse_DK")
Landuse <- terra::unwrap(Landuse_DK)

v <- vect(Polygons, "polygons", crs = terra::crs(Landuse))
Inside <- summarise_polygons(Rast = Landuse, Polygons = v,
                            Vars = c("Agriculture","Forest"))
```

```{r, echo = F}
kbl(Inside) |> 
  kableExtra::kable_paper() |> 
  scroll_box(width = "500px", height = "200px")
```

## Both

```{r Both}
Both <- summarise_polygons(Rast = Landuse, Polygons = v,
  Vars = c("Agriculture","Forest"), type = "Both", dist = 2000)
```

```{r tableBoth, echo = F}
kbl(Both) |> 
  kableExtra::kable_paper() |> 
  scroll_box(width = "500px", height = "300px")
```


## Outside

```{r Outside}
Outside <- summarise_polygons(Rast = Landuse, Polygons = v,
  Vars = c("Agriculture","Forest"), type = "Outside", dist = 2000)
```

```{r tableOutside, echo = F}
kbl(Outside) |> 
  kableExtra::kable_paper() |> 
  scroll_box(width = "500px", height = "300px")
```


# Temporal continuity

## calculate_tempcont

```{r corine}
data(corine)
corine <- terra::unwrap(corine)
```

```{r corineplot, cache=TRUE, echo=FALSE}
ggplot() + 
  geom_spatraster(data = corine) +
  facet_wrap(~lyr) +
  scale_fill_wiki_d(na.translate = F, name = "Landuse") + 
  theme(legend.position = "none")
```


## calculate_tempcont (Ordinal data) {.smaller} 

* Ordinal dataset

```{r TempContOrd}
TempContOrd <- calculate_tempcont(Rast = corine,
                                 Vars = c("Coniferous forest" ,"Mixed forest"))
```

```{r ordplot, echo=FALSE}
ggplot() + 
  geom_spatraster(data = TempContOrd) +
  scale_fill_viridis_c(name = "Ordinal continuity")
```


## calculate_tempcont (Time Series data) {.smaller} 

* Numeric dataset, not recomended for unevenly spaced time series.

```{r TempContNum}
TempContNum <- calculate_tempcont(Rast = corine,
                                  years = c(1990, 2000, 2006, 2012, 2018),
                                 Vars = c("Coniferous forest" ,"Mixed forest"))
```

```{r numplot, echo=FALSE}
ggplot() + 
  geom_spatraster(data = TempContNum) +
  scale_fill_viridis_c(name = "Numeric continuity")
```

# Questions?

# Extra functionalities

## Save as cloud optimized geotiffs

```{r saveasCOG}
write_cog(TempContNum, "TempContNum.tif")
terra::writeRaster(TempContNum, "TempContNum2.tif")
file.size("TempContNum.tif")
file.size("TempContNum2.tif")
```

* The file is `r round(file.size("TempContNum2.tif")/file.size("TempContNum.tif"), 2)` smaller

```{r removefiles, echo=FALSE, include=FALSE}
file.remove("TempContNum2.tif")
```

## Example

```{r setup2, include=FALSE}
library(leaflet)
library(leafem)
```




<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

<script src="https://unpkg.com/georaster"></script>

<script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>

```{r, warning = FALSE, echo = F}
leaflet(width = 0, height = 0)
```


<style>
        /* Overall map style */
        #map {position: absolute; top: 0; bottom: 0; left: 0; right: 0;}

        .legend {
            padding: 6px 8px;
            font: 14px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            /*box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);*/
            /*border-radius: 5px;*/
            line-height: 24px;
            color: #555;
        }

        .legend h4 {
            text-align: left;
            font-size: 16px;
            margin: 2px 12px 8px;
            color: #777;
        }

        .legend span {
            position: relative;
            margin: 0 0px 0 8px;
            bottom: 3px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin: 0 8px 0 14px;
            opacity: 1;
        }

        .legend i.icon {
            background-size: 18px;
            background-color: rgba(255, 255, 255, 1);
        }
	</style>


<div id="map" style="width: 100%; height: 480px; position: relative;"></div>

<script>
  // Load base tiles ----

  // OpenStreetMap Tiles
    // Dark Matter Tiles
  var DarkMatter = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
  });

  // Initiate leaflet ----
  // This needs to be done before loading the Georasters
  var map = L.map('map', { 
      center: [56.25, 12], // Centered on Denmark
      zoom: 7, // Worked well
      layers: [DarkMatter] // Default layers
  });

  // Set URL to cog
  var random_rast_dk_url = "https://raw.githubusercontent.com/derek-corcoran-barrios/DanishLanduseProblem/master/SolutionNum_0.02.tif"

  // Load georaster layer and add to map
  parseGeoraster(random_rast_dk_url).then(georaster => {
      var random_rast_dk = new GeoRasterLayer({
          georaster,
          opacity: 0.75,
          resolution: 128, // 128 seems to be a good compromise
          pixelValuesToColorFn: function(pixelValues){
              var pixelValue = pixelValues[0]; 
              // Map pixel values to colors
              var colorArray = ['#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462','#b3de69','#fccde5'];
              if (pixelValue >= 1 && pixelValue <= 8){
                  return colorArray[pixelValue - 1];
              } else {
                  return undefined;
              }   
          }
      });       
      random_rast_dk.addTo(map);
  });
  
  var legend = L.control({ position: "bottomright" });
legend.onAdd = function(map) {
    var div = L.DomUtil.create("div", "legend");
    
    div.innerHTML += "<h4>Projected landuse</h4>";
    div.innerHTML += '<i class="legend-icon" style="background: #8dd3c7"></i><span class="legend-text">ForestDryPoor</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #ffffb3"></i><span class="legend-text">ForestDryRich</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #bebada"></i><span class="legend-text">ForestWetPoor</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #fb8072"></i><span class="legend-text">ForestWetRich</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #80b1d3"></i><span class="legend-text">OpenDryPoor</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #fdb462"></i><span class="legend-text">OpenDryRich</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #b3de69"></i><span class="legend-text">OpenWetPoor</span><br>';
    div.innerHTML += '<i class="legend-icon" style="background: #fccde5"></i><span class="legend-text">OpenWetRich</span><br>';

    return div;
};

// Add legend
legend.addTo(map);



</script>